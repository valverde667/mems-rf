import os
import threading, time


# from spectrometer_sim import spectrometerSimCalibration \
#     as ssc
def startSim(e, v):
    print("starting simulation in thread")
    s = ssc(e, v)
    s.simulate()


def startSimOS(e, v):
    path = "/home/timo/Documents/Warp/atap-meqalac-simulations/Spectrometer-Sim/"
    os.system(f'python3 '
              f'{path}spectrometer_sim_calibration.py '
              f'--energy {e} --capV {v}')  # --dt {dt}')


def progressbar(f):
    f = f % 1
    f = int(f * 40)
    l = f * "="
    r = (40 - f) * "_"
    print(f"\u001b[31m progress : <<{l}{r}>> \u001b[0m")


def acceptedIntervalImproved():
    # first narrowed run 2020-03-6
    # l = [[11000.0, 6000.0], [21000.0, 11000.0],
    #      [13000.0, 8000.0], [19000.0, 8000.0],
    #      [17000.0, 11000.0], [11000.0, 5000.0],
    #      [21000.0, 10000.0], [5000.0, 3000.0], [17000.0,
    #                                             10000.0],
    #      [11000.0, 7000.0], [19000.0, 9000.0],
    #      [7000.0, 3000.0], [13000.0, 7000.0],
    #      [7000.0, 4000.0], [19000.0, 11000.0],
    #      [21000.0, 9000.0], [17000.0, 9000.0], [17000.0,
    #                                             8000.0],
    #      [9000.0, 5000.0], [13000.0, 6000.0],
    #      [15000.0, 8000.0], [9000.0, 4000.0],
    #      [15000.0, 9000.0], [15000.0, 7000.0],
    #      [19000.0, 10000.0], [17000.0, 7000.0]]
    # second narrow run
    l = [[3874.432004841634, 2000],
         [3780.210108256073, 2000],
         [3692.372081676539, 2000],
         [3610.3807481236468, 2000],
         [3533.698930618012, 2000],
         [3722.285835370092, 2100],
         [3635.707293153174, 2100],
         [3555.837476532927, 2100],
         [3482.1392085299667, 2100],
         [3414.0753121649095, 2100],
         [3620.6386562503526, 2200],
         [3539.073864907558, 2200],
         [3464.542654752081, 2200],
         [3396.5078488045356, 2200],
         [3334.4322700855378, 2200],
         [3586.0286243135743, 2300],
         [3506.838911334222, 2300],
         [3435.0167041489967, 2300],
         [3370.1780932343136, 2300],
         [3312.691456199165, 2300],
         [3634.826640085289, 2400],
         [3554.7712244792756, 2400],
         [3483.701769255071, 2400],
         [3421.6466549827437, 2400],
         [3368.9482878090676, 2400],
         [3772.792151620105, 2500],
         [3689.8942279369703, 2500],
         [3617.7944677531045, 2500],
         [3556.6951388165, 2500], [3506.938647273927, 2500],
         [4001.353037700604, 2600],
         [3913.7018584302155, 2600],
         [3838.725399056321, 2600],
         [3776.735461225065, 2600],
         [3728.0744510832274, 2600],
         [4321.935790934036, 2700],
         [4227.606032448491, 2700],
         [4147.906479654195, 2700],
         [4083.1795386979234, 2700],
         [3966.9576349713916, 2700],
         [4735.904002912977, 2800],
         [4633.018666481279, 2800],
         [4541.55093270069, 2800],
         [4364.801706851327, 2800],
         [4129.635588150685, 2800],
         [5244.638985626281, 2900],
         [5104.311282994813, 2900],
         [4912.31611502599, 2900],
         [4727.942992123605, 2900],
         [4551.5621508354225, 2900],
         [5844.2107351102995, 3000],
         [5702.478244718075, 3000],
         [5569.3294330282015, 3000],
         [5443.961132420622, 3000],
         [5325.570175275286, 3000],
         [6040.576099458409, 3100],
         [5889.956771175312, 3100],
         [5746.476883313486, 3100],
         [5610.039157745179, 3100],
         [5480.308765479026, 3100],
         [6236.482691720854, 3200],
         [6085.2459880891365, 3200],
         [5939.210855921236, 3200],
         [5799.282365689927, 3200],
         [5666.038681125656, 3200],
         [6433.022854031349, 3300],
         [6275.838795741625, 3300],
         [6128.122974367484, 3300],
         [5988.252236078913, 3300],
         [5853.404946935633, 3300],
         [6627.688553080622, 3400],
         [6467.738811932624, 3400],
         [6315.0353250957105, 3400],
         [6171.586554537305, 3400],
         [6036.0442924012605, 3400],
         [6819.175783068381, 3500],
         [6657.107809008291, 3500],
         [6502.395321744579, 3500],
         [6354.351418816601, 3500],
         [6214.392125918183, 3500],
         [7013.3557027234165, 3600],
         [6846.831871100119, 3600],
         [6686.966176619391, 3600],
         [6537.368265926255, 3600],
         [6393.734288998905, 3600],
         [7218.967464832773, 3700],
         [7034.921375111289, 3700],
         [6871.839244143869, 3700],
         [6717.052476267917, 3700],
         [6571.799973926021, 3700],
         [7447.820056899927, 3800],
         [7240.365917205319, 3800],
         [7057.168213864864, 3800],
         [6897.90337398918, 3800],
         [6747.662832452855, 3800],
         [7319.036471174101, 3900],
         [7251.022281574237, 3900],
         [7166.810280470874, 3900],
         [7059.9370887044615, 3900],
         [6924.472659510906, 3900],
         [7786.874631359873, 4000],
         [7599.023368413806, 4000],
         [7422.742238462502, 4000],
         [7256.805361344377, 4000],
         [7099.986856897829, 4000],
         [7376.89382635956, 4100],
         [7343.630444285276, 4100],
         [7303.223287351921, 4100],
         [7251.025399888793, 4100],
         [7182.389826225204, 4100],
         [8190.308417639526, 4200],
         [7987.176462560468, 4200],
         [7790.180027665452, 4200],
         [7606.481660137757, 4200],
         [7438.675947391776, 4200],
         [8409.434050754198, 4300],
         [8180.306283468923, 4300],
         [7968.555499666337, 4300],
         [7775.833562243659, 4300],
         [7601.436225694977, 4300],
         [9279.552799825591, 4400],
         [8976.247332795328, 4400],
         [8673.996148607064, 4400],
         [8374.331085840087, 4400],
         [8101.2165963796115, 4400],
         [8736.403013315135, 4500],
         [8515.735362978616, 4500],
         [8309.456977162941, 4500],
         [8117.150840534277, 4500],
         [7938.399937758775, 4500],
         [8136.459855608176, 4600],
         [8076.007719591217, 4600],
         [8008.39850065175, 4600],
         [7935.0594123095125, 4600],
         [7858.0462281811515, 4600],
         [8928.8665248229, 4700], [8749.179000940114, 4700],
         [8558.250837553469, 4700],
         [8372.419964723656, 4700],
         [8196.98973083782, 4700],
         [9544.200803964308, 4800],
         [9315.310251125291, 4800],
         [9083.421363328524, 4800],
         [8856.190924448523, 4800],
         [8640.950749699534, 4800],
         [9725.12328386688, 4900],
         [9474.418343708361, 4900],
         [9249.724480998117, 4900],
         [9041.635114137625, 4900],
         [8847.98897724185, 4900],
         [9748.390289027382, 5000],
         [9512.520237952813, 5000],
         [9288.96066524439, 5000],
         [9077.076023482212, 5000],
         [8876.235841116644, 5000],
         [9894.688864172056, 5100],
         [9681.197256360258, 5100],
         [9465.461340997808, 5100],
         [9362.396991560681, 5100], [9195.0390003392, 5100],
         [10115.53930231249, 5200],
         [9887.01672589972, 5200],
         [9754.215390109151, 5200],
         [9593.93759671153, 5200],
         [9379.685110155611, 5200],
         [10338.219265567115, 5300],
         [10080.745498854116, 5300],
         [9697.136107408214, 5300],
         [9497.54517086405, 5300], [9302.97255548261, 5300],
         [10528.499870548201, 5400],
         [10269.009060207443, 5400],
         [9872.400392821059, 5400],
         [9693.245384708978, 5400],
         [9518.441063727663, 5400],
         [10718.951563627845, 5500],
         [10460.45872398136, 5500],
         [10215.847120491424, 5500],
         [9986.295582541617, 5500],
         [9769.851710326508, 5500],
         [10911.249250639907, 5600],
         [10649.19442081815, 5600],
         [10413.063577565266, 5600],
         [10203.787869469706, 5600],
         [9934.015027309195, 5600],
         [11107.779949027668, 5700],
         [10838.389626025593, 5700],
         [10588.202291082836, 5700],
         [10348.053637509971, 5700],
         [10115.225291708983, 5700],
         [11306.207549942465, 5800],
         [11032.240867985058, 5800],
         [10772.17308149684, 5800],
         [10528.723501290142, 5800],
         [10308.682546856133, 5800],
         [11504.462967485848, 5900],
         [11224.779118503606, 5900],
         [10956.910286232553, 5900],
         [10709.52505464344, 5900],
         [10498.101660687826, 5900],
         [11699.75098204327, 6000],
         [11414.666521863135, 6000],
         [11144.380185257764, 6000],
         [10891.342578494285, 6000],
         [10654.063109356637, 6000],
         [11893.757804674515, 6100],
         [11605.249926960842, 6100],
         [11333.136330116697, 6100],
         [11069.668120034645, 6100],
         [10825.6014970238, 6100],
         [12088.178368639594, 6200],
         [11796.673760964331, 6200],
         [11519.261423339412, 6200],
         [11253.918527059112, 6200],
         [11005.308337492164, 6200],
         [12283.428105791618, 6300],
         [11987.673131497248, 6300],
         [11707.564742059749, 6300],
         [11439.577052170978, 6300],
         [11188.783238914992, 6300],
         [12477.206812072058, 6400],
         [12176.741007373923, 6400],
         [11893.350384729549, 6400],
         [11624.226406263291, 6400],
         [11369.792070599045, 6400],
         [12671.06104232972, 6500],
         [12365.534692695037, 6500],
         [12078.233175920204, 6500],
         [11806.41503913958, 6500],
         [11547.15023986809, 6500],
         [12865.26783966617, 6600],
         [12554.731265433418, 6600],
         [12263.169274802836, 6600],
         [11987.069039689095, 6600],
         [11724.111614220796, 6600],
         [13059.906109455345, 6700],
         [12744.184636315653, 6700],
         [12447.86718651498, 6700],
         [12167.352762013352, 6700],
         [11902.097014668583, 6700],
         [13255.802175399636, 6800],
         [12934.612841108592, 6800],
         [12632.62513054068, 6800],
         [12348.354707063045, 6800],
         [12080.492185375875, 6800],
         [13451.446144229325, 6900],
         [13124.97971139397, 6900],
         [12817.732775086828, 6900],
         [12528.982995987086, 6900],
         [12257.657591618346, 6900],
         [13646.64646631355, 7000],
         [13315.151366239137, 7000],
         [13003.193114729836, 7000],
         [12709.784348281995, 7000],
         [12433.320401230749, 7000],
         [13841.50875095219, 7100],
         [13505.354641662636, 7100],
         [13189.14071895515, 7100],
         [12891.421720758131, 7100],
         [12610.484132877105, 7100],
         [14036.69024342375, 7200],
         [13696.033303117683, 7200],
         [13375.213042162171, 7200],
         [13072.956023896857, 7200],
         [12788.170200070803, 7200],
         [14232.099393149869, 7300],
         [13886.97545345569, 7300],
         [13561.187282209434, 7300],
         [13253.436751202695, 7300],
         [12963.92240483452, 7300],
         [14426.992108708357, 7400],
         [14077.614843245312, 7400],
         [13747.565981710297, 7400],
         [13436.0829627684, 7400],
         [13141.909110424309, 7400],
         [14622.385119253977, 7500],
         [14267.70104477537, 7500],
         [13933.496455078948, 7500],
         [13618.058407478295, 7500],
         [13319.90774182746, 7500],
         [14818.46030653451, 7600],
         [14458.60534338296, 7600],
         [14118.697782432315, 7600],
         [13799.06547210939, 7600],
         [13497.10318160581, 7600],
         [15013.103648000793, 7700],
         [14649.981547904588, 7700],
         [14305.130495115789, 7700],
         [13980.702328655994, 7700],
         [13674.930749195219, 7700],
         [15209.159936336207, 7800],
         [14840.931849409199, 7800],
         [14492.781553935612, 7800],
         [14164.3433756354, 7800],
         [13853.756420218078, 7800],
         [15404.739671425423, 7900],
         [15031.799947002206, 7900],
         [14679.927336632552, 7900],
         [14347.637887156501, 7900],
         [14031.484205841314, 7900],
         [15598.076328424515, 8000],
         [15220.77019360704, 8000],
         [14864.970715418733, 8000],
         [14528.331070277003, 8000],
         [14209.577965519135, 8000],
         [15791.363058913621, 8100],
         [15409.535538370139, 8100],
         [15049.59545670871, 8100],
         [14710.076382966927, 8100],
         [14389.12952139898, 8100],
         [15986.241379356281, 8200],
         [15599.024444464318, 8200],
         [15235.61632558048, 8200],
         [14892.284317705566, 8200],
         [14567.245833989888, 8200],
         [16181.850351288722, 8300],
         [15790.077288309896, 8300],
         [15420.434392474102, 8300],
         [15072.82272856104, 8300],
         [14743.348401959436, 8300],
         [16376.181611278733, 8400],
         [15979.136201254812, 8400],
         [15605.791578920154, 8400],
         [15253.691957493354, 8400],
         [14920.651759807208, 8400],
         [16569.89735776863, 8500],
         [16168.971621943867, 8500],
         [15791.77489267753, 8500],
         [15435.401580767711, 8500],
         [15098.255347249045, 8500],
         [16764.430474519224, 8600],
         [16359.127384567842, 8600],
         [15978.025998530527, 8600],
         [15617.317914831332, 8600],
         [15276.16556365627, 8600],
         [16960.102886795805, 8700],
         [16549.682382568917, 8700],
         [16163.724444029842, 8700],
         [15798.51315063395, 8700],
         [15453.53227214492, 8700],
         [17155.308131078047, 8800],
         [16739.287050666244, 8800],
         [16348.215953704186, 8800],
         [15979.272641408335, 8800],
         [15630.571721088623, 8800],
         [17350.805246459036, 8900],
         [16928.83332583535, 8900],
         [16533.04754830931, 8900],
         [16160.202033998745, 8900],
         [15807.811802962364, 8900],
         [17548.04801795884, 9000],
         [17120.583223965747, 9000],
         [16719.253583789265, 9000],
         [16341.516005792453, 9000],
         [15984.937864572106, 9000],
         [17745.559523574837, 9100],
         [17311.746623644485, 9100],
         [16906.05072214405, 9100],
         [16523.05925221465, 9100],
         [16161.827104224732, 9100],
         [17939.558414690437, 9200],
         [17502.866414364064, 9200],
         [17092.020418634464, 9200],
         [16704.315835712372, 9200],
         [16339.222223618324, 9200],
         [18138.801047814908, 9300],
         [17696.283608695085, 9300],
         [17278.22307353194, 9300],
         [16886.42427562873, 9300],
         [16517.754830984934, 9300],
         [18335.17645377005, 9400],
         [17887.73287748375, 9400],
         [17465.119426517485, 9400],
         [17069.042630496413, 9400],
         [16695.760959954725, 9400],
         [18529.549448765072, 9500],
         [18078.03677706186, 9500],
         [17652.446541015895, 9500],
         [17251.58602306955, 9500],
         [16873.148262947434, 9500],
         [18724.105059645444, 9600],
         [18268.843764679954, 9600],
         [17839.86089114614, 9600],
         [17434.72390958517, 9600],
         [17052.0301373905, 9600],
         [18918.237821071893, 9700],
         [18460.432324143745, 9700],
         [18026.485559780256, 9700],
         [17617.156595952245, 9700],
         [17229.06571501197, 9700],
         [19112.209330464288, 9800],
         [18652.338444410856, 9800],
         [18212.551356574102, 9800],
         [17797.35565151627, 9800],
         [17409.770264245268, 9800],
         [19304.920349538144, 9900],
         [18844.138723282893, 9900],
         [18400.56816380141, 9900],
         [17981.731329081216, 9900],
         [17587.927828503056, 9900],
         [19500.02002800125, 10000],
         [19034.555942371175, 10000],
         [18587.32590435887, 10000],
         [18164.57832751887, 10000],
         [17763.943453911073, 10000],
         [19693.201797171907, 10100],
         [19222.908729737766, 10100],
         [18772.647437227206, 10100],
         [18347.099062747046, 10100],
         [17942.604829772114, 10100],
         [19883.166107505378, 10200],
         [19410.26791055985, 10200],
         [18960.752222682397, 10200],
         [18530.21576287856, 10200],
         [18120.21298975417, 10200],
         [20074.123367044394, 10300],
         [19601.615622221674, 10300],
         [19149.730293722012, 10300],
         [18713.18775719398, 10300],
         [18299.567342346334, 10300],
         [20272.02226631002, 10400],
         [19786.958045236803, 10400],
         [19332.57068199339, 10400],
         [18898.794517621205, 10400],
         [18478.89207530315, 10400],
         [20464.260538142047, 10500],
         [19968.15468771936, 10500],
         [19511.48464516549, 10500],
         [19076.78247699856, 10500],
         [18659.355553654554, 10500],
         [20659.40721928743, 10600],
         [20161.391216123095, 10600],
         [19695.856576159993, 10600],
         [19257.200930103256, 10600],
         [18838.82335899857, 10600],
         [20853.762557105816, 10700],
         [20347.38234984709, 10700],
         [19877.33530427123, 10700],
         [19436.34926363108, 10700],
         [19018.144795187698, 10700],
         [21052.208324409832, 10800],
         [20534.731268794825, 10800],
         [20055.159772484185, 10800],
         [19614.366402017487, 10800],
         [19194.19730730386, 10800],
         [21250.789189780087, 10900],
         [20725.973045291295, 10900],
         [20238.681505089327, 10900],
         [19790.5239076167, 10900],
         [19368.42871186953, 10900],
         [21447.622906746466, 11000],
         [20920.077171930105, 11000],
         [20426.427899906448, 11000],
         [19968.39184019844, 11000],
         [19542.7936533766, 11000],
         [21642.47738164691, 11100],
         [21115.618039033074, 11100],
         [20614.884395184807, 11100],
         [20150.010959066378, 11100],
         [19719.168829671362, 11100],
         [21836.096924640788, 11200],
         [21310.834865109235, 11200],
         [20803.720720463396, 11200],
         [20331.419316467425, 11200],
         [19889.782954732138, 11200],
         [21499.956764851166, 11300],
         [20990.91404446578, 11300],
         [20511.330582231396, 11300],
         [20064.344276662727, 11300],
         [21688.393801451944, 11400],
         [21179.056392398277, 11400],
         [20692.615647963492, 11400],
         [20241.76226766948, 11400],
         [21877.153930679, 11500],
         [21366.048650895995, 11500],
         [20875.02089910293, 11500],
         [20414.982559662058, 11500],
         #manual now
         [21250, 11500],
         [21250, 11400],
         [21250, 11600],
         [21500, 11400],
         [21500, 11500],
         [21500, 11600],
         [21800, 11500],
         [21800, 11600],
         [21800, 11700],
         [21800, 11800],
         [21800, 11900],
         [21800, 12000],
         ]
    # 795 sims
    out = []
    for nrg in range(1000, 23000, 250):
        for volt in range(0, 12000, 250):
            for i in l:
                if nrg - 1000 <= i[0] <= nrg + 1000 and \
                        volt - 500 <= i[1] <= volt + 500:
                    if [nrg, volt] not in out:
                        out.append([nrg, volt])
    print(f'Length of out {out.__len__()}')
    return out


def defaultRun(maxCores=8 + 1):
    # 2020-03-06
    nrgs = list(range(1000, 23000, 2000))
    volts = list(range(1000, 12000, 1000))
    #
    counter = 0
    tr = list()
    totalruns = nrgs.__len__() * volts.__len__()
    for nrg in nrgs:
        for volt in volts:
            counter += 1
            print(f"in loop {volt} - {nrg}")
            tr.append(
                threading.Thread(target=startSimOS, args=(
                    nrg, volt
                )))
            tr[-1].start()
            while threading.active_count() > 1:
                print(f'Active Simulation Threads :'
                      f'{threading.active_count() - 1}\nrunning'
                      f' Simulation {counter} out of '
                      f'{totalruns}\n'
                      f'Estimated remaining time: '
                      f'{(totalruns - counter) * 3 / (maxCores - 1):.0f} '
                      f'minutes ('
                      f'{(totalruns - counter) * 3 / (maxCores - 1) / 60:.0f}'
                      f' hours)')
                progressbar(counter / totalruns)
                time.sleep(3)


def narrowedRun(maxCores=8 + 1):
    tr = list()
    # runtime ~ 3min per sim per core
    counter = 0
    pairs = acceptedIntervalImproved()
    pairs.reverse()
    totalruns = pairs.__len__()
    for pair in pairs:
        nrg, volt = pair[0], pair[1]
        counter += 1
        print(f"in loop {nrg}eV - {volt}V")
        tr.append(threading.Thread(target=startSimOS, args=(
            nrg, volt
        )))
        tr[-1].start()
        while threading.active_count() >= maxCores:
            print(f'Active Simulation Threads :'
                  f'{threading.active_count() - 1}\nrunning'
                  f' Simulation {counter} out of '
                  f'{totalruns}\n'
                  f'Estimated remaining time: '
                  f'{(totalruns - counter) * 3 / (maxCores - 1):.0f} '
                  f'minutes ('
                  f'{(totalruns - counter) * 3 / (maxCores - 1) / 60:.0f}'
                  f' hours)')
            progressbar(counter / totalruns)
            time.sleep(3)
    while threading.active_count() > 1:
        print(f'Finishing Simulations')
        time.sleep(3)

#############################
### Testing needed time resultion -> 5e-9
#############################
# for t in [1e-6, 1e-7, 1e-8, 5e-8, 1e-9, 5e-9, 1e-10]:
#     tr.append(threading.Thread(target=startSimOS, args=(
#         15000, 6000, t # just some example
#     )))
#     tr[-1].start()
#     while threading.active_count() >= maxCores:
#         print(f'Active Simulation Threads :'
#               f' {threading.active_count() - 1}')
#         time.sleep(3)
#

####
